<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BoardGameBuddy — Scorer Sandbox</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #f5f5f5; color: #333; }
    header { background: #1a237e; color: white; padding: 16px 24px; }
    header h1 { font-size: 1.25rem; }
    header p { font-size: 0.85rem; opacity: 0.8; margin-top: 4px; }
    .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; height: calc(100vh - 72px); }
    .panel { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
    .panel-header { padding: 12px 16px; background: #e8eaf6; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .panel-body { flex: 1; padding: 12px 16px; overflow: auto; display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 0.85rem; color: #555; }
    textarea { width: 100%; flex: 1; font-family: 'Courier New', monospace; font-size: 0.8rem; border: 1px solid #ccc; border-radius: 4px; padding: 8px; resize: none; }
    input[type=file] { font-size: 0.85rem; }
    button { background: #1a237e; color: white; border: none; border-radius: 4px; padding: 10px 20px; font-size: 0.9rem; cursor: pointer; align-self: flex-start; }
    button:hover { background: #283593; }
    button:disabled { background: #999; cursor: not-allowed; }
    #output { font-family: 'Courier New', monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; }
    .success { color: #1b5e20; }
    .error { color: #b71c1c; }
    .hint { font-size: 0.8rem; color: #777; font-style: italic; }
    .badge { background: #c5cae9; color: #1a237e; border-radius: 12px; padding: 2px 8px; font-size: 0.75rem; }
    @media (max-width: 768px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <h1>BoardGameBuddy — Scorer Sandbox</h1>
  <p>Teste scorer.js-Dateien direkt im Browser, ohne Gerät oder Build.</p>
</header>

<div class="layout">
  <!-- Left panel: inputs -->
  <div class="panel">
    <div class="panel-header">
      <span>Eingabe</span>
      <span class="badge">scorer.js + PlayerInput</span>
    </div>
    <div class="panel-body">
      <label>scorer.js laden</label>
      <input type="file" id="scorerFile" accept=".js">

      <label>cards.json laden (optional)</label>
      <input type="file" id="cardsFile" accept=".json">

      <label>PlayerInput-Array (JSON editierbar)</label>
      <textarea id="inputJson" spellcheck="false"></textarea>

      <button id="runBtn" onclick="runScorer()">Scorer ausführen</button>
      <span class="hint">Das PlayerInput-JSON kann direkt bearbeitet werden.</span>
    </div>
  </div>

  <!-- Right panel: output -->
  <div class="panel">
    <div class="panel-header">
      <span>Ausgabe</span>
      <span class="badge">PlayerScoreResult[]</span>
    </div>
    <div class="panel-body">
      <pre id="output" class="hint">Noch kein Ergebnis — scorer.js laden und ausführen.</pre>
    </div>
  </div>
</div>

<script>
// Default Wizard example input
const WIZARD_EXAMPLE = [
  {
    "playerName": "Alice",
    "bid": 3,
    "tricks": 3,
    "previousScore": 0
  },
  {
    "playerName": "Bob",
    "bid": 2,
    "tricks": 1,
    "previousScore": 50
  },
  {
    "playerName": "Carol",
    "bid": 0,
    "tricks": 2,
    "previousScore": 20
  }
];

// Populate default input
document.getElementById('inputJson').value = JSON.stringify(WIZARD_EXAMPLE, null, 2);

let scorerSource = null;
let cardsJson = null;

document.getElementById('scorerFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    scorerSource = ev.target.result;
    document.getElementById('output').textContent = `scorer.js geladen: ${file.name}`;
    document.getElementById('output').className = 'hint';
  };
  reader.readAsText(file);
});

document.getElementById('cardsFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      cardsJson = JSON.parse(ev.target.result);
    } catch (err) {
      document.getElementById('output').textContent = `Fehler beim Parsen von cards.json: ${err.message}`;
      document.getElementById('output').className = 'error';
    }
  };
  reader.readAsText(file);
});

function runScorer() {
  const outputEl = document.getElementById('output');

  if (!scorerSource) {
    outputEl.textContent = 'Fehler: Keine scorer.js-Datei geladen.';
    outputEl.className = 'error';
    return;
  }

  let inputData;
  try {
    inputData = JSON.parse(document.getElementById('inputJson').value);
  } catch (err) {
    outputEl.textContent = `Fehler: Ungültiges JSON in Eingabe.\n${err.message}`;
    outputEl.className = 'error';
    return;
  }

  try {
    // CommonJS shim: intercept require() calls
    const moduleExports = {};
    const requireShim = (mod) => {
      if (mod === './cards.json' || mod === 'cards.json') {
        if (cardsJson !== null) return cardsJson;
        throw new Error('cards.json nicht geladen. Bitte cards.json-Datei auswählen.');
      }
      throw new Error(`require('${mod}') nicht unterstützt in Sandbox.`);
    };

    // Execute scorer.js in a sandboxed function scope
    const fn = new Function('module', 'exports', 'require', scorerSource);
    fn(moduleExports, moduleExports, requireShim);

    // Find the score function — common export names
    const exports = moduleExports.exports || moduleExports;
    const scoreFn =
      exports.score ||
      exports.scoreRound ||
      exports.calculateScores ||
      exports.default;

    if (typeof scoreFn !== 'function') {
      const keys = Object.keys(exports).join(', ');
      outputEl.textContent = `Fehler: Keine score-Funktion gefunden.\nExportierte Schlüssel: ${keys || '(keine)'}`;
      outputEl.className = 'error';
      return;
    }

    const result = scoreFn(inputData);
    outputEl.textContent = JSON.stringify(result, null, 2);
    outputEl.className = 'success';
  } catch (err) {
    outputEl.textContent = `Laufzeitfehler:\n${err.message}\n\n${err.stack || ''}`;
    outputEl.className = 'error';
  }
}
</script>
</body>
</html>
